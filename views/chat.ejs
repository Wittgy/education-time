<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <title>You Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin-top: 20px;
            background: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .chat-container {
            height: calc(100vh - 100px);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .user-list {
            background: #fff;
            border-right: 1px solid #e0e0e0;
            height: 100%;
            overflow-y: auto;
        }
        
        .chat-area {
            background: #f8f9fa;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #e5ddd5;
            background-image: url('https://web.whatsapp.com/img/bg-chat-tile-light_a4be512e7195b6b733d9110b408f075d.png');
        }
        
        .message-input {
            background: #f0f0f0;
            padding: 10px;
            border-top: 1px solid #e0e0e0;
        }
        
        .user {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .user:hover {
            background: #f5f5f5;
        }
        
        .user.active {
            background: #e9ebee;
        }
        
        .message {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 8px 12px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 0.5px rgba(0,0,0,0.1);
        }
        
        .sent {
            align-self: flex-end;
            background-color: #dcf8c6;
        }
        
        .received {
            align-self: flex-start;
            background-color: #ffffff;
        }
        
        .message-time {
            font-size: 11px;
            color: #666;
            text-align: right;
            margin-top: 3px;
        }
        
        .status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .online {
            background: #4caf50;
            position: absolute;
        }
        
        .typing-indicator {
            font-size: 12px;
            color: #999;
            font-style: italic;
            margin-left: 10px;
            height: 20px;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .system-message {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin: 10px 0;
            padding: 5px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        
        .message-sender {
            font-weight: bold;
            font-size: 0.8em;
            margin-bottom: 3px;
            color: #555;
        }
        
        .sent .message-sender {
            text-align: right;
        }
        
        .received .message-sender {
            text-align: left;
        }
        
        .color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .status.typing {
            background-color: #ffcc00;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .file-message:hover { background-color: #f8f9fa !important; }
        #filePreview { max-width: 100%; }
        video::-webkit-media-controls { border-radius: 0 0 8px 8px; }
        .file-preview-container { max-width: 200px; }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

           /* Medya Görüntüleme Stilleri */
    .media-container {
        max-width: 100%;
        margin-bottom: 8px;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .media-container:hover {
        transform: scale(1.02);
    }
    
    .img-preview {
        max-width: 100%;
        max-height: 300px;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .video-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        background: #000;
    }
        /* Mobile cihazlarda çevrimiçi yazısını gizle */
  @media (max-width: 768px) {
    .user .text-muted.small {
      display: none !important;
    }
    .img-preview, .video-preview {
        max-height: 200px;
    }
    
    /* Kullanıcı listesinde avatar boyutunu küçült */
    .user .avatar {
      width: 32px;
      height: 32px;
    }
    
    /* Kullanıcı adı font boyutunu küçült */
    .user strong {
      font-size: 0.9em;
    }
  }
    </style>
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="chat-container d-flex">
                    <!-- Kullanıcı listesi aynı kaldı -->
                    <div class="user-list col-md-4 p-0">
                        <div class="p-3 bg-primary text-white d-flex justify-content-between">
                            <h5 class="mb-0">Üyeler</h5>
                            <span id="onlineCount" class="badge bg-light text-dark">0</span>
                        </div>
                        <div id="userList"></div>
                    </div>
                    
                    <!-- Sohbet alanı -->
                    <div class="chat-area col-md-8 p-0 d-flex flex-column">
                        <div class="p-3 bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" id="chatTitle">Genel Sohbet</h5>
                            <div class="typing-indicator" id="typingIndicator"></div>
                        </div>
                        
                        <div class="messages" id="messages"></div>
                        
                        <!-- DOSYA YÜKLEME EKLENTİSİ (Değişen tek kısım) -->
                        <div class="message-input">
                            <form id="messageForm" enctype="multipart/form-data">
                                <input type="file" id="fileInput" accept="image/*,video/*,.pdf,.gif" hidden>
                                <div class="input-group">
                                    <button type="button" id="attachBtn" class="btn btn-secondary">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <input type="text" class="form-control" id="messageInput" placeholder="Bir mesaj yazın...">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </form>
                            <div id="filePreview" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    // Socket.io bağlantısını güçlendir
    const socket = io({
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
        transports: ['websocket']
    });

    let username = '';
    let isConnected = false;

    // Kullanıcı adını al
    function getUsername() {
        username = localStorage.getItem('chat-username') || '';
        while (!username || username.trim() === '') {
            username = prompt("Lütfen kullanıcı adınızı girin:") || '';
            if (username.trim()) {
                localStorage.setItem('chat-username', username.trim());
            }
        }
        return username.trim();
    }

    // Bağlantıyı başlat
    function connect() {
        if (isConnected) return;
        
        username = getUsername();
        socket.emit('new user', username);
        isConnected = true;
        
        // Bağlantı durumu kontrolü
        setInterval(() => {
            socket.emit('ping', () => {
                console.log('Bağlantı aktif');
            });
        }, 30000);
    }

    // DOSYA YÜKLEME FONKSİYONU (Yeni eklendi)
    async function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            return await response.json();
        } catch (err) {
            console.error('Yükleme hatası:', err);
            return null;
        }
    }

    // MESAJ GÖNDERME (Güncellendi)
    async function sendMessage() {
        const message = $('#messageInput').val().trim();
        const fileInput = $('#fileInput')[0];
        
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            
            // Dosya boyut kontrolü (50MB)
            if (file.size > 50 * 1024 * 1024) {
                alert('Dosya boyutu 50MB\'ı aşamaz!');
                return;
            }
            
            const { url, type } = await uploadFile(file);
            if (url) {
                socket.emit('chat message', {
                    message,
                    file: { url, type },
                    timestamp: new Date().toISOString()
                });
                $('#fileInput').val('');
                $('#filePreview').empty();
            }
        } else if (message) {
            socket.emit('chat message', { 
                message,
                timestamp: new Date().toISOString()
            });
        }
        
        $('#messageInput').val('');
        socket.emit('stop typing');
    }

    // DOSYA ÖNİZLEME (Yeni eklendi)
    $('#attachBtn').click(() => $('#fileInput').click());
    
    $('#fileInput').change(function() {
        const file = this.files[0];
        if (!file) return;
        
        const preview = `
            <div class="alert alert-light d-flex justify-content-between align-items-center p-2">
                <div>
                    <i class="fas fa-${file.type.includes('image') ? 'image' : 
                                    file.type.includes('video') ? 'video' : 'file'} me-2"></i>
                    ${file.name} (${(file.size / 1024).toFixed(1)}KB)
                </div>
                <button class="btn btn-sm btn-danger" id="removeFile">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        $('#filePreview').html(preview);
    });

    $(document).on('click', '#removeFile', () => {
        $('#fileInput').val('');
        $('#filePreview').empty();
    });



    // Yazma durumu
    let typing = false;
    let typingTimeout;
    
    $('#messageInput').on('input', function() {
        if (!isConnected) return;
        
        if (!typing) {
            typing = true;
            socket.emit('typing');
        }
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            typing = false;
            socket.emit('stop typing');
        }, 2000);
    });

    $('#messageForm').submit(function(e) {
        e.preventDefault();
        sendMessage();
    });
    // Enter tuşu ile gönder
    $('#messageInput').keypress(function(e) {
        if (e.which === 13) {
            e.preventDefault();
            sendMessage();
        }
    });

    $('#sendButton').click(sendMessage);

    // Socket.io olayları
    socket.on('user list', function(users) {
        $('#userList').empty();
        $('#onlineCount').text(users.length);
        
        const isMobile = window.innerWidth <= 768;
        
        users.forEach(user => {
          const isCurrentUser = user.username === username;
          const typingText = user.typing ? ' (yazıyor...)' : '';
          
          $('#userList').append(`
            <div class="user ${isCurrentUser ? 'active' : ''}" data-user-id="${user.id}">
              <div class="d-flex align-items-center">
                <div class="color-indicator" style="background-color: ${user.color || '#cccccc'};"></div>
                <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=random" 
                     class="avatar me-3" alt="${user.username}">
                <div class="flex-grow-1" style="
                @media (max-width: 768px) {
                    margin-right: 20px;
                    margin-left: -10px;
                    font-size: 0.7em;"
                }>
                  <strong>${user.username}</strong>
                  ${!isMobile ? `<div class="text-muted small">${typingText || 'Çevrimiçi'}</div>` : ''}
                </div>
                <span class="status ${user.typing ? 'typing' : 'online'}"></span>
              </div>
            </div>
          `);
        });
      });
      
      // Ekran boyutu değiştiğinde yenile
      $(window).resize(function() {
        if(this.resizeTO) clearTimeout(this.resizeTO);
        this.resizeTO = setTimeout(function() {
          socket.emit('get user list');
        }, 300);
      });

     // MESAJ ALMA (Güncellendi)
     socket.on('chat message', (data) => {
        let content = '';
        
        // Dosya varsa uygun şekilde render et
        if (data.file) {
            const fileType = data.file.type || data.file.url.split('.').pop().toLowerCase();
            
            // Resim/GIF için optimize edilmiş görüntüleme
            if (fileType.includes('image')) {
                content = `
                <div class="media-container">
                    <img src="${data.file.url}" 
                         class="img-preview" 
                         alt="Gönderilen resim"
                         onclick="openMediaModal('${data.file.url}', 'image')">
                </div>`;
            }
            // Video için optimize oynatıcı
            else if (fileType.includes('video')) {
                content = `
                <div class="media-container">
                    <video controls class="video-preview" onclick="event.stopPropagation()">
                        <source src="${data.file.url}" type="video/mp4">
                        Tarayıcınız video oynatmayı desteklemiyor.
                    </video>
                </div>`;
            }
            // Diğer dosyalar
            else {
                content = `
                <div class="file-message bg-light p-2 rounded mb-2">
                    <a href="${data.file.url}" target="_blank" class="text-decoration-none">
                        <i class="fas fa-file-download me-2"></i>Dosyayı indir
                    </a>
                </div>`;
            }
        }
        
        // Metin mesajı varsa ekle
        if (data.message) {
            content += `<div class="message-text mt-2">${data.message}</div>`;
        }
    
        addMessage(data.username, content, data.userId === socket.id, data.timestamp, data.color);
    });

    // Büyük görüntüleme için modal fonksiyonu
function openMediaModal(url, type) {
    const modalContent = type === 'image' 
        ? `<img src="${url}" class="img-fluid" style="max-height: 80vh;">`
        : `<video controls autoplay class="w-100"><source src="${url}"></video>`;
    
    const modal = `
    <div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-body text-center p-0">
                    ${modalContent}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                    <a href="${url}" download class="btn btn-primary">
                        <i class="fas fa-download me-1"></i> İndir
                    </a>
                </div>
            </div>
        </div>
    </div>`;
    
    $('body').append(modal);
    $('#mediaModal').modal('show');
    $('#mediaModal').on('hidden.bs.modal', () => $('#mediaModal').remove());
}


    socket.on('typing', function(typingUser) {
        if (typingUser !== username) {
            $('#typingIndicator').text(`${typingUser} yazıyor...`);
        }
    });

    socket.on('stop typing', function() {
        $('#typingIndicator').text('');
    });

    socket.on('system message', function(data) {
        addSystemMessage(data.text, data.type);
    });

    socket.on('connect_error', (error) => {
        console.error('Bağlantı hatası:', error);
        addSystemMessage('Sunucuya bağlanılamıyor. Lütfen sayfayı yenileyin...', 'error');
    });

     // Mesaj ekleme fonksiyonu (Güncellendi)
     function addMessage(sender, content, isSent, timestamp, color) {
        const time = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 
                                new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        const messageClass = isSent ? 'sent' : 'received';
        const messageColor = isSent ? '#dcf8c6' : (color || '#ffffff');
        
        $('#messages').append(`
            <div class="message ${messageClass}" style="background-color: ${messageColor}">
                <div class="message-sender">${sender}</div>
                ${content}
                <div class="message-time">${time}</div>
            </div>
        `);
        
        scrollToBottom();
    }
    

    function addSystemMessage(text, type) {
        $('#messages').append(`
            <div class="system-message ${type}">
                ${text}
            </div>
        `);
        scrollToBottom();
    }

    function scrollToBottom() {
        const messages = $('#messages')[0];
        messages.scrollTop = messages.scrollHeight;
    }

    // Sayfa yüklendiğinde bağlan
    connect();
});
</script>
</body>
</html>